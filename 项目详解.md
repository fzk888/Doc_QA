# 文档问答系统（Doc_QA）项目详解

## 概述

- 类型：基于检索增强生成（RAG）的文档问答服务
- 能力：支持多格式文档上传解析（PDF、Word、Markdown、TXT、PPTX、HTML、Excel、CSV、图片OCR），构建向量索引（FAISS），混合检索（BGE 向量 + BM25 关键词），重排序（BGE-reranker），并通过大语言模型生成答案（SSE 流式或一次性返回）。

## 运行入口

- 入口服务：`app.py`
- 主要接口：
  - `/list_kb` 列举知识库 `app.py:123`
  - `/update_vectordb` 上传并更新向量库 `app.py:156`
  - `/view_guiding_questions` 生成引导性问题 `app.py:345`
  - `/mulitdoc_qa` 多文档问答（支持 SSE）`app.py:435`
  - `/remove_file` 删除知识库中的文件 `app.py:413`
  - `/final_response` 汇总最终响应 `app.py:590`

## 配置说明

- 配置文件：`config.yaml`
- 核心字段（不含密钥具体值）：
  - `paths.kb_dir` 知识库根目录
  - `paths.model_dir` BGE 嵌入模型路径
  - `paths.reranker_model_dir` Reranker 模型路径
  - `paths.openai_api_base` 模型 API 地址
  - `paths.openai_api_keys` 模型 API 密钥
  - `models.llm_model` LLM 名称
  - `settings.device` 运行设备（`cpu`/`cuda`）
  - `system.max_workers` 文档处理并行进程数

## 模块说明

### 知识库管理（`Knowledge_based_async.py`）

- 类：`KnowledgeBase`（`Knowledge_based_async.py:32`）
- 功能：
  - 目录结构初始化（`image_directory`、`markdown_directory`、`faiss_index`）`Knowledge_based_async.py:33-48`
  - 加载向量库 `load_vectordb()` `Knowledge_based_async.py:49-61`
  - 解析并分块上传文件 `process_files()`（按扩展名分组，顺序处理，避免并发内存压力）`Knowledge_based_async.py:62-181`
  - 文档向量化与批量合并 `vectorize_documents()`（FAISS，批量大小可配置）`Knowledge_based_async.py:184-211`
  - 保存与合并索引 `save_vectordb()` `Knowledge_based_async.py:220-224`
  - 首次构建或增量更新 `update_vectordb()`（删除旧文件向量、处理新文件、合并保存）`Knowledge_based_async.py:256-348`
  - 删除文件及相关向量、Markdown、图片 `remove_file()` `Knowledge_based_async.py:350-385`

### 文档解析（`documen_processing.py` 与 `add/morefile/*`）

- PDF 解析：
  - 表格与正文抽取、图片保存 `extract_all_table_and_textand_image()` `documen_processing.py:45-172`
  - OCR 兜底（Maker API）`pdf_to_markdown()` `documen_processing.py:541-601`
  - 综合流程 `process_pdf()`（两套策略，失败自动切换）`documen_processing.py:632-742`
- Word（`.docx`）：`process_doc_file()`（Pandoc 转换失败则回退到 `python-docx`，并支持图片 OCR 提取文本）`documen_processing.py:214-378`
- Markdown：`process_md_file()`（支持问答格式与普通段落两种拆分策略）`documen_processing.py:380-465`
- TXT：`process_txt_file()`（大块分割并清洗换行）`documen_processing.py:468-538`
- PPTX：`add/morefile/ppt_processing.py` 通过 `add/morefile/presentation.py` 的 `chunk()` 分页解析 `ppt_processing.py:44-105`
- HTML/Excel/CSV/图片：`add/morefile/html_processing.py`、`excel_processing.py`、`pic_processing.py`

### 检索与排序

- BM25 关键词检索：`BM25Search`（`bm25_search.py:13-19` 初始化；`bm25_search.py:51-60` 检索）
- 向量检索 + BM25 融合：`functions.get_top_documents()` 并行检索、按 `file_path` 去重、候选限制与重排 `functions.py:125-167`
- 文档重排序：`DocumentReranker`（Reranker 计算分数并排序）`document_reranker.py:15-46`

### 问答生成（LLM）

- 多文档问答：`functions.run_llm_MulitDocQA()`（支持仅知识库答案或混合模式、SSE 流式输出、源链接透传）`functions.py:454-729`
- 无知识库自由对话：`functions.only_llm()` `functions.py:730-780`
- SSE 流封装：`functions.stream_type()`、`functions.stream_type_url()` `functions.py:798-803`
- 历史记录管理：`KBState` 全局状态 `functions.py:114-123`

## 数据与目录约定

- 知识库根：`paths.kb_dir`（默认 `./Knowledge_based`）
- 知识库结构：
  - `faiss_index/` 向量库索引（`index.faiss`、`index.pkl`）
  - `markdown_directory/` 解析后的 Markdown
  - `images/` 文档配套图片（按文档名分目录）
  - `uploads/` 最近一次上传的原始文件副本

## 流程与原理

- 上传更新：客户端调用 `/update_vectordb` 上传文件 → 后端保存到 `uploads/` 与 `doc_directory` 副本（`app.py:186-203`） → `KnowledgeBase.update_vectordb()` 首次或增量构建向量库 → 保存 FAISS 索引并刷新全局状态（BM25 在内存中初始化）`app.py:206-263`
- 检索融合：`get_top_documents(query)` 并发执行 BGE 向量检索与 BM25 检索 → 合并结果（按 `file_path` 去重）→ 送入 Reranker 计算分数并选出 Top-N `functions.py:125-167`
- 生成回答：根据文档相关性决定是直接使用问答文档答案还是基于相关段落组织答案 → 通过 SSE 逐块发送到前端，最后发送 `[DONE]` 结束标记 `functions.py:454-729`、`app.py:531-583`
- 引导性问题：基于知识库文档内容，使用 LLM 生成简短引导问题，帮助用户探索知识库 `functions.py:219-285`、接口 `app.py:399-411`

## 性能与稳定性

- 文档处理顺序执行各类型组，避免并发占用过多内存 `Knowledge_based_async.py:92-179`
- FAISS 向量化按批次处理，合并到单索引，并清理 GPU 缓存 `Knowledge_based_async.py:184-218`
- BM25 初始化移除了冗余 I/O 与进度条以提升速度 `bm25_search.py`
- 重要日志：提示初始化模型、检索与重排流程与性能信息 `functions.py`、`app.py`

## 可选组件

- 前端页面：`server/index.html`（直接本地打开；后端 CORS 允许文件协议与跨端口）`app.py:58-65`
- OCR 服务：`add/ocr/ocr_app.py`（若启用，可将 `documen_processing.py:24` 的 `url_f` 指向该服务地址，以支持图片内容 OCR）

## 使用示例

- 启动服务：
  - `python app.py`
- 创建/更新知识库：
  - `POST /update_vectordb`（表单：`kb_name` 与 `files[]`）
- 多文档问答（SSE）：
  - `POST /mulitdoc_qa`（JSON：`messages`、`kb_name`、`only_chatKBQA`、`stream=true`）


